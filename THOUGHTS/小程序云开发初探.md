# 云开发定义
云开发为开发者提供完整的原生云端支持和微信服务支持，弱化后端和运维概念，无需搭建服务器，使用平台提供的 API 进行核心业务开发，即可实现快速上线和迭代，同时这一能力，同开发者已经使用的云服务相互兼容，并不互斥

> 使用微信云开发，同时也可以使用自己服务器做后台，等于多个后端服务器  
> 但是需要考虑什么数据放微信，什么数据放自己服务器

# 云开发成本
一个环境对应一整套独立的云开发资源，包括数据库、存储空间、云函数等资源。各个环境是相互独立的，用户开通云开发后即创建了一个环境，默认可拥有最多两个环境。在实际开发中，建议每一个正式环境都搭配一个测试环境，所有功能先在测试环境测试完毕后再上到正式环境。以初始可创建的两个环境为例，建议一个创建为 test 测试环境，一个创建为 release 正式环境

> 腾讯为每个小程序提供2个免费的云环境（等于2个免费服务器的概念）  
> 但是服务器资源使用是有限制的（比如数据库大小，CDN流量等），不同的价格配置不一样（等于买云服务器）  
> 价格参考：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/billing/quota.html

## 云开发四大功能

|能力|作用|说明|
|:-|:-|:-|
|云函数|无需自建服务器|在云端运行的代码，微信私有协议天然鉴权，开发者只需编写自身业务逻辑代码|
|数据库|无需自建数据库|一个既可在小程序前端操作，也能在云函数中读写的 JSON 数据库|
|存储|无需自建存储和 CDN|在小程序前端直接上传/下载云端文件，在云开发控制台可视化管理|
|云调用|原生微信服务集成|基于云函数免鉴权使用小程序开放接口的能力，包括服务端调用、获取开放数据等能力|

## 1.云函数
云函数即在云端（服务器端）运行的函数。在物理设计上，一个云函数可由多个文件组成，占用一定量的 CPU 内存等计算资源；各云函数完全独立；可分别部署在不同的地区。开发者无需购买、搭建服务器，只需编写函数代码并部署到云端即可在小程序端调用，同时云函数之间也可互相调用。

**一个云函数的写法与一个在本地定义的 JavaScript 方法无异，代码运行在云端 Node.js 中**。当云函数被小程序端调用时，定义的代码会被放在 Node.js 运行环境中执行。我们可以如在 Node.js 环境中使用 JavaScript 一样在云函数中进行网络请求等操作，而且我们还可以通过云函数后端 SDK 搭配使用多种服务，比如使用云函数 SDK 中提供的数据库和存储 API 进行数据库和存储的操作，这部分可参考数据库和存储后端 API 文档。

**云开发的云函数的独特优势在于与微信登录鉴权的无缝整合**。当小程序端调用云函数时，云函数的传入参数中会被注入小程序端用户的 openid，开发者无需校验 openid 的正确性因为微信已经完成了这部分鉴权，开发者可以直接使用该 openid。

> 云函数比较像封装function API，等于把客户端上运行的js代码丢给云服务器来运行  
> 不消耗客户端资源，而使用服务器资源，但需要通信  
> 云函数的好处是 **无需维护复杂的鉴权机制，即可获取天然可信任的用户登录态（openid）**  
> 还有好处是可以在云服务管理看板上看到函数的调用次数，运行结果  

## 2.云数据库
云开发提供了一个 JSON 数据库，顾名思义，数据库中的每条记录都是一个 JSON 格式的对象。一个数据库可以有多个集合（相当于关系型数据中的表），集合可看做一个 JSON 数组，数组中的每个对象就是一条记录，记录的格式是 JSON 对象

关系型数据库和 JSON 数据库的概念对应关系如下表：

|关系型|文档型|
|:-|:-|
|数据库 database|	数据库 database|
|表 table	|集合 collection|
|行 row	|记录 record / doc|
|列 column	|字段 field|

### 2.1数据类型
String：字符串
Number：数字
Object：对象
Array：数组
Bool：布尔值
Date：时间
Geo：多种地理位置类型，详见下
Null

> 我感觉类似mongo的数据库  
> 用这个数据库的问题是在于数据首先不在自己物理服务器  
> 然后所有的表类型和传统服务器不一样，要重新设计

### 2.2权限管理
数据库的权限分为小程序端和管理端，管理端包括云函数端和控制台。小程序端运行在小程序中，读写数据库受权限控制限制，管理端运行在云函数上，拥有所有读写数据库的权限。云控制台的权限同管理端，拥有所有权限。小程序端操作数据库应有严格的安全规则限制

我们提供了两种权限控制方案，第一种是初期提供的基础的四种简易权限设置，第二种是灵活的、可自定义的权限控制，即数据库安全规则

> 需要开发者学习这些功能

### 2.3增删改查
```javascript
const db = wx.cloud.database()

db.collection('todos').add({
  // data 字段表示需新增的 JSON 数据
  data: {
    // _id: 'todo-identifiant-aleatoire', // 可选自定义 _id，在此处场景下用数据库自动分配的就可以了
    description: "learn cloud database",
    due: new Date("2018-09-01"),
    tags: [
      "cloud",
      "database"
    ],
    // 为待办事项添加一个地理位置（113°E，23°N）
    location: new db.Geo.Point(113, 23),
    done: false
  },
  success: function(res) {
    // res 是一个对象，其中有 _id 字段标记刚创建的记录的 id
    console.log(res)
  }
})
```
> 传统数据库的功能都有，需要学习对应的SDK的相关语法即可

### 2.4实时数据推送（类似socket长链接）
云开发数据库支持实时推送变更数据的能力，给定查询条件，每当数据库更新而导致查询条件对应的查询结果发生变更时，小程序可收到一个更新事件，其中可获取更新内容和更新后的查询结果快照。

实时数据推送有广泛应用场景，此处是一些示例：

* 聊天/即时通信：小游戏内聊天、大厅广播、区服广播等；企业内部小程序中的即时通信能力等
* 多人小游戏：使用状态同步的小游戏，如棋牌类等回合制游戏
* 协作工具：如在线协作文档、团队任务管理等
* 实时应用状态同步：以信息流为例，可以实时获取最新文章、以及最新评论、点赞、通知等内容，让交互更顺畅自然

### 2.5其他功能支持
地理位置、聚合、索引、数据迁移

> 我感觉除非是完全独立的应用，不然基本上不可能使用这个数据库来存储数据的  
> 还有就是和已有数据的整合也是一个问题

## 3.存储
云存储提供高可用、高稳定、强安全的云端存储服务，支持任意数量和形式的非结构化数据存储，如视频和图片，并在控制台进行可视化管理。云存储包含以下功能：

* 存储管理：支持文件夹，方便文件归类。支持文件的上传、删除、移动、下载、搜索等，并可以查看文件的详情信息
* 权限设置：可以灵活设置哪些用户是否可以读写该文件夹中的文件，以保证业务的数据安全
* 上传管理：在这里可以查看文件上传历史、进度及状态
* 文件搜索：支持文件前缀名称及子目录文件的搜索
* 组件支持：支持在 image、audio 等组件中传入云文件 ID

> **这个比较好用，等于一个物理存储服务**  
> 也可以在管理端很方便的查看存储的文件

## 4.云调用
云调用主要有3个功能：1.服务端调用 2.开放数据调用 3.消息推送

### 4.1服务端调用
微信小程序提供了一些给后台服务端调用的API，比如模板消息、访问留存、小程序码等  
https://developers.weixin.qq.com/miniprogram/dev/api-backend/  
这个云调用即你不需要写这些后端的代码来调用这些API，直接用云函数来调用即可（在服务器中，需要先拿access_token再调API，云调用则省去了换access_token的步骤）

### 4.2开放数据调用
有些敏感的数据本来需要开发者在后台校验与解密，才能拿到开放数据  
但是如果用云调用则可以直接拿，省去了后台写校验与解密的代码

### 4.3消息推送
跟微信公众号一样，小程序也可以处理一些和用户互动的消息，推客服消息、模板消息等  
如果在服务端需要拿调用凭证（即access_token）才能调微信的接口，如果用云调用，则省去了拿access_token的步骤

## 总结
云开发在我看来致力于为不是太懂后端（即文档中说的弱化后端概念，或公司端程序员居多）的程序员提供便利的服务器开发支持  
主要是云函数（模块化、微服务化概念），云数据库（省去后端自建库）、云存储（省去后端自建）、云调用（简化后端处理凭证解密）

云开发适应于小型项目，独立项目，非saas项目  
对于较大型项目（可能需要花钱买更高级的云开发服务器），或自有数据库来说，不是很适应  
我觉得可以结合起来用，云开发不是说必须用这些功能，用的到就用，用不到就用自己服务器

云开发微信官方文档：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html

如何看待小程序云开发？：https://www.zhihu.com/question/290632115